# Python DSMA script

This is an intermediary script between clients and Fortanix DSM Accelerator (DSMA). This replicates the existing plugin in LUA by using DSMA logic instead of Fortanix DSM.

## Setup
### DSMA Container
- The following docker compose can be used to start a DSMA container 
- The following will start fortanixse/testsvc:private on port 8443 with given endpoint and api key.
- $ docker-compose up
```yaml
dsma :
  image: fortanixse/testsvc:private
  container_name: dsma_shrys
  environment:
    - FORTANIX_API_ENDPOINT=https://sdkms.fortanix.com
    - FORTANIX_API_KEY=" "
  ports:
    - "8443:8443"
```

### Config.yaml
```yaml
---
DEBUG : False
PORT : "5000"
DSMA_PORT: "8443"
NO_FILE_LOGS : False
FLASK_LOG_PATH : "/tmp/"
API_ENDPOINT : "http://X.X.X.X"
API_KEY : " "
AES-256 : "aes_encrypted"
TOK-NUM8-256: "plugin_python_tokenizer"
```

- Use DEBUG to enable debug logs
- PORT to specify which port the python script will listen on
- DSMA_PORT to specify which port the the DSMA container is listening on
- NO_FILE_LOGS set to true to disable file logs at FLASK_LOG_PATH
- API_ENDPOINT refers to the endpoint IP of DSMA
- API_KEY for the app API_KEY from Fortanix DSM
- AES-256 set to the key name in fortanix dsm. This is used to perform the corresponding operation as found in mt-schema.json
- TOK-NUM8-256 set to the key name in fortanix dsm. This is used to perform the corresponding operation as found in mt-schema.json
- IMPORTANT: Example in mt-schema.json the key is "AES-256" which is used to perform CBC Enc. To tell DSMA which key needs to be used, pass the keyname in config yaml for "AES-256"
``` json
    "x-encrypted": {
        "key": "AES-256",
        "mode": "CBC"
    }
```


## Sample  
(use https://www.base64encode.org/  to view content)
### 1. Protect
#### Input:
```json
{
  "message_type": "mt202",
  "payload":  "ewogICAgImlkIjogewogICAgICAgICJzY29wZSI6ICJDU1MuUGF5bWVudCIsCiAgICAgICAgImlkIjogIjc3MzkzMiIsCiAgICAgICAgInZlcnNpb24iOiA2CiAgICB9LAogICAgInBheW1lbnRTdGF0ZSI6ICJTRVRUTEVNRU5UX0lOU1RSVUNURUQiLAogICAgInNvdXJjZVN5c3RlbSI6ICJGSU5BQ0xFX1RSRUFTVVJZX0VNRUEiLAogICAgInRpbWVzdGFtcCI6ICIyMDIxLTA5LTEzVDA5OjMwOjI1Ljg4OTMzMCswMTowMCIsCiAgICAiZW50aXR5SWQiOiAiMTYxIiwKICAgICJjYXNoZmxvd0lkTGlzdCI6IFsKICAgICAgICB7CiAgICAgICAgICAgICJzY29wZSI6ICJDU1MuQ2FzaGZsb3ciLAogICAgICAgICAgICAiaWQiOiAiNzczOTMzIiwKICAgICAgICAgICAgInZlcnNpb24iOiAxCiAgICAgICAgfSwKICAgICAgICB7CiAgICAgICAgICAgICJzY29wZSI6ICJDU1MuQ2FzaGZsb3ciLAogICAgICAgICAgICAiaWQiOiAiNzczOTMxIiwKICAgICAgICAgICAgInZlcnNpb24iOiAxCiAgICAgICAgfSwKICAgICAgICB7CiAgICAgICAgICAgICJzY29wZSI6ICJDU1MuQ2FzaGZsb3ciLAogICAgICAgICAgICAiaWQiOiAiNzczOTMwIiwKICAgICAgICAgICAgInZlcnNpb24iOiAxCiAgICAgICAgfQogICAgXSwKICAgICJwcm9kdWN0VHlwZSI6ICJNb25leU1hcmtldExvYW4iLAogICAgImdyb3VwaW5nUmVmIjogbnVsbCwKICAgICJub3N0cm9JZCI6ICJBRVNUVVNEMTYxIiwKICAgICJzc2lPaWQiOiAiMDAwMDAwMDAtMDAwMC0wMDAwLTAwMDAtMDAwMDA1NjFmMWRlIiwKICAgICJwcmlvcml0eSI6ICJSRUdVTEFSIiwKICAgICJwYXltZW50RGF0ZSI6ICIyMDIxLTA5LTEzIiwKICAgICJjdXJyZW5jeSI6ICJVU0QiLAogICAgImFtb3VudCI6ICItMTMxNzEuMzkiLAogICAgImV4Y2hhbmdlUmF0ZSI6IG51bGwsCiAgICAic3dpZnRTdXBwcmVzc2lvbiI6ICJOT05FIiwKICAgICJzd2l0Y2hUaWNrZXRSZWYiOiBudWxsLAogICAgInBheW1lbnRDb25maXJtYXRpb25TdGF0dXMiOiBudWxsLAogICAgIm5ldEFwcHJvdmVJbmRpY2F0b3IiOiAiMCIsCiAgICAiY291bnRlcnBhcnR5SWQiOiAiMTE3Mzg0OTMiLAogICAgInRyYW5zYWN0aW9uVHlwZSI6ICJDTElFTlQiLAogICAgImNzc1NvdXJjZSI6ICJGT1MiLAogICAgImlucHV0QnkiOiAiU1lTVEVNIgp9Cg=="
}
```
#### Output
```json
{
    "result": "eyJpZCI6IHsic2NvcGUiOiAiQ1NTLlBheW1lbnQiLCAiaWQiOiAiNzczOTMyIiwgInZlcnNpb24iOiA2fSwgInBheW1lbnRTdGF0ZSI6ICJTRVRUTEVNRU5UX0lOU1RSVUNURUQiLCAic291cmNlU3lzdGVtIjogIkZJTkFDTEVfVFJFQVNVUllfRU1FQSIsICJ0aW1lc3RhbXAiOiAiMjAyMS0wOS0xM1QwOTozMDoyNS44ODkzMzArMDE6MDAiLCAiZW50aXR5SWQiOiAiMTYxIiwgImNhc2hmbG93SWRMaXN0IjogW3sic2NvcGUiOiAiQ1NTLkNhc2hmbG93IiwgImlkIjogIjc3MzkzMyIsICJ2ZXJzaW9uIjogMX0sIHsic2NvcGUiOiAiQ1NTLkNhc2hmbG93IiwgImlkIjogIjc3MzkzMSIsICJ2ZXJzaW9uIjogMX0sIHsic2NvcGUiOiAiQ1NTLkNhc2hmbG93IiwgImlkIjogIjc3MzkzMCIsICJ2ZXJzaW9uIjogMX1dLCAicHJvZHVjdFR5cGUiOiAiTW9uZXlNYXJrZXRMb2FuIiwgImdyb3VwaW5nUmVmIjogbnVsbCwgIm5vc3Ryb0lkIjogIkFFU1RVU0QxNjEiLCAic3NpT2lkIjogIjAwMDAwMDAwLTAwMDAtMDAwMC0wMDAwLTAwMDAwNTYxZjFkZSIsICJwcmlvcml0eSI6ICJSRUdVTEFSIiwgInBheW1lbnREYXRlIjogIjIwMjEtMDktMTMiLCAiY3VycmVuY3kiOiAiVVNEIiwgImFtb3VudCI6ICI0ZjYzNTc0ZjY2NTM2MjZlNTc3MTcxNTQ1NzcwNzI0NzcyNDEzMjUwNTA1MTNkM2QuNzI0MzZkNTU3ODQ3NmU0NzRhMzYzODM3NzgzNTc1NDM3YTZiNjg0NjU0NzczZDNkIiwgImV4Y2hhbmdlUmF0ZSI6IG51bGwsICJzd2lmdFN1cHByZXNzaW9uIjogIk5PTkUiLCAic3dpdGNoVGlja2V0UmVmIjogbnVsbCwgInBheW1lbnRDb25maXJtYXRpb25TdGF0dXMiOiBudWxsLCAibmV0QXBwcm92ZUluZGljYXRvciI6ICIwIiwgImNvdW50ZXJwYXJ0eUlkIjogIjQyMzcxMTU3IiwgInRyYW5zYWN0aW9uVHlwZSI6ICJDTElFTlQiLCAiY3NzU291cmNlIjogIkZPUyIsICJpbnB1dEJ5IjogIlNZU1RFTSJ9"
}
```
### 2. Reveal
#### Input:
```json
{
  "message_type": "mt202",
  "payload": "ewogICAgImFtb3VudCI6ICI2NjM4Njc0YzZlNTY2Yjc5NDM3YTQ0NjE2MjRlNDg2YjQxNjU0NTYxNmQ2NzNkM2QuNTY1MTZhNjY2MTcwMzY1MDdhNDQ1MTM4NTIyZjM3Nzc2Mzc4NmI0MTUwNjczZDNkIiwKICAgICJjYXNoZmxvd0lkTGlzdCI6IFsKICAgICAgICB7CiAgICAgICAgICAgICJpZCI6ICI3NzM5MzMiLAogICAgICAgICAgICAic2NvcGUiOiAiQ1NTLkNhc2hmbG93IiwKICAgICAgICAgICAgInZlcnNpb24iOiAxCiAgICAgICAgfSwKICAgICAgICB7CiAgICAgICAgICAgICJpZCI6ICI3NzM5MzEiLAogICAgICAgICAgICAic2NvcGUiOiAiQ1NTLkNhc2hmbG93IiwKICAgICAgICAgICAgInZlcnNpb24iOiAxCiAgICAgICAgfSwKICAgICAgICB7CiAgICAgICAgICAgICJpZCI6ICI3NzM5MzAiLAogICAgICAgICAgICAic2NvcGUiOiAiQ1NTLkNhc2hmbG93IiwKICAgICAgICAgICAgInZlcnNpb24iOiAxCiAgICAgICAgfQogICAgXSwKICAgICJjb3VudGVycGFydHlJZCI6ICI0MjM3MTE1NyIsCiAgICAiY3NzU291cmNlIjogIkZPUyIsCiAgICAiY3VycmVuY3kiOiAiVVNEIiwKICAgICJlbnRpdHlJZCI6ICIxNjEiLAogICAgImV4Y2hhbmdlUmF0ZSI6IG51bGwsCiAgICAiZ3JvdXBpbmdSZWYiOiBudWxsLAogICAgImlkIjogewogICAgICAgICJpZCI6ICI3NzM5MzIiLAogICAgICAgICJzY29wZSI6ICJDU1MuUGF5bWVudCIsCiAgICAgICAgInZlcnNpb24iOiA2CiAgICB9LAogICAgImlucHV0QnkiOiAiU1lTVEVNIiwKICAgICJuZXRBcHByb3ZlSW5kaWNhdG9yIjogIjAiLAogICAgIm5vc3Ryb0lkIjogIkFFU1RVU0QxNjEiLAogICAgInBheW1lbnRDb25maXJtYXRpb25TdGF0dXMiOiBudWxsLAogICAgInBheW1lbnREYXRlIjogIjIwMjEtMDktMTMiLAogICAgInBheW1lbnRTdGF0ZSI6ICJTRVRUTEVNRU5UX0lOU1RSVUNURUQiLAogICAgInByaW9yaXR5IjogIlJFR1VMQVIiLAogICAgInByb2R1Y3RUeXBlIjogIk1vbmV5TWFya2V0TG9hbiIsCiAgICAic291cmNlU3lzdGVtIjogIkZJTkFDTEVfVFJFQVNVUllfRU1FQSIsCiAgICAic3NpT2lkIjogIjAwMDAwMDAwLTAwMDAtMDAwMC0wMDAwLTAwMDAwNTYxZjFkZSIsCiAgICAic3dpZnRTdXBwcmVzc2lvbiI6ICJOT05FIiwKICAgICJzd2l0Y2hUaWNrZXRSZWYiOiBudWxsLAogICAgInRpbWVzdGFtcCI6ICIyMDIxLTA5LTEzVDA5OjMwOjI1Ljg4OTMzMCswMTowMCIsCiAgICAidHJhbnNhY3Rpb25UeXBlIjogIkNMSUVOVCIKfQ=="
}
```
#### Output
```json
{
    "result": "eyJhbW91bnQiOiAiLTEzMTcxLjM5IiwgImNhc2hmbG93SWRMaXN0IjogW3siaWQiOiAiNzczOTMzIiwgInNjb3BlIjogIkNTUy5DYXNoZmxvdyIsICJ2ZXJzaW9uIjogMX0sIHsiaWQiOiAiNzczOTMxIiwgInNjb3BlIjogIkNTUy5DYXNoZmxvdyIsICJ2ZXJzaW9uIjogMX0sIHsiaWQiOiAiNzczOTMwIiwgInNjb3BlIjogIkNTUy5DYXNoZmxvdyIsICJ2ZXJzaW9uIjogMX1dLCAiY291bnRlcnBhcnR5SWQiOiAiMTE3Mzg0OTMiLCAiY3NzU291cmNlIjogIkZPUyIsICJjdXJyZW5jeSI6ICJVU0QiLCAiZW50aXR5SWQiOiAiMTYxIiwgImV4Y2hhbmdlUmF0ZSI6IG51bGwsICJncm91cGluZ1JlZiI6IG51bGwsICJpZCI6IHsiaWQiOiAiNzczOTMyIiwgInNjb3BlIjogIkNTUy5QYXltZW50IiwgInZlcnNpb24iOiA2fSwgImlucHV0QnkiOiAiU1lTVEVNIiwgIm5ldEFwcHJvdmVJbmRpY2F0b3IiOiAiMCIsICJub3N0cm9JZCI6ICJBRVNUVVNEMTYxIiwgInBheW1lbnRDb25maXJtYXRpb25TdGF0dXMiOiBudWxsLCAicGF5bWVudERhdGUiOiAiMjAyMS0wOS0xMyIsICJwYXltZW50U3RhdGUiOiAiU0VUVExFTUVOVF9JTlNUUlVDVEVEIiwgInByaW9yaXR5IjogIlJFR1VMQVIiLCAicHJvZHVjdFR5cGUiOiAiTW9uZXlNYXJrZXRMb2FuIiwgInNvdXJjZVN5c3RlbSI6ICJGSU5BQ0xFX1RSRUFTVVJZX0VNRUEiLCAic3NpT2lkIjogIjAwMDAwMDAwLTAwMDAtMDAwMC0wMDAwLTAwMDAwNTYxZjFkZSIsICJzd2lmdFN1cHByZXNzaW9uIjogIk5PTkUiLCAic3dpdGNoVGlja2V0UmVmIjogbnVsbCwgInRpbWVzdGFtcCI6ICIyMDIxLTA5LTEzVDA5OjMwOjI1Ljg4OTMzMCswMTowMCIsICJ0cmFuc2FjdGlvblR5cGUiOiAiQ0xJRU5UIn0="
}
